---
title: "Whole game"
format: docx
editor: visual
echo: TRUE
warning: FALSE
message: FALSE
results: FALSE
editor_options: 
  chunk_output_type: console
---

# Welcome and Introduction

El siguiente repositorio será a partir del siguiente libro guía: https://r4ds.hadley.nz/preface-2e.html. New co-author: Mine Çetinkaya-Rundel.

Próximas herramientas a leer:
- https://ggplot2-book.org/
- https://www.tidymodels.org/ 
- https://www.tmwr.org/ 
- https://quarto.org/ 

Data science is an exciting discipline that allows you to transform raw data into understanding (comprensión), insight (perspectiva), and knowledge (conocimiento).

Typical data science project:

1) Import
2) Tidy
3) Transform - Visualize - Model
4) Communicate

*Wranglind*: Together, tidying and transforming are called wrangling because getting your data in a form that’s natural to work with often feels like a fight!

You don’t need to be an expert programmer to be a successful data scientist, but learning more about programming pays off because becoming a better programmer allows you to automate common tasks and solve new problems with greater ease.

```{r, message=TRUE}
library(tidyverse)
```

This tells you that tidyverse loads nine packages: `dplyr, forcats, ggplot2, lubridate, purrr, readr, stringr, tibble, tidyr`. Message: It also tells you which functions from the tidyverse conflict with functions in base R (or from other packages you might have loaded)

Packages in the tidyverse change fairly frequently. You can see if updates are available by running `tidyverse_update()`.

We’ll use many packages from outside the tidyverse in this book. For example, we’ll use the following packages because they provide interesting datasets for us to work with in the process of learning R:

```{r}
# install.packages(
#   c("arrow", "babynames", "curl", "duckdb", "gapminder", 
#     "ggrepel", "ggridges", "ggthemes", "hexbin", "janitor", "Lahman", 
#     "leaflet", "maps", "nycflights13", "openxlsx", "palmerpenguins", 
#     "repurrrsive", "tidymodels", "writexl")
#   )
```

*Para comentar varias líneas de código a la vez:* command + shift + c 

# Whole game

Goal in this part of the book is to give you a rapid overview of the main tools of data science: importing, tidying, transforming, and visualizing data.

## 1. Data visualization

This chapter focuses on `ggplot2`.

Data:

```{r}
library(palmerpenguins) # base de datos de pingüinos
library(ggthemes) # paleta de colores

palmerpenguins::penguins

view(penguins) # interactive data viewer
glimpse(penguins) 

?penguins
```

In the tidyverse, we use special data frames called *tibbles* that you will learn more about soon.

Con mis conocimientos, intentaré replicar la figura que aparece ahí, o lo más parecido que pueda.

```{r}
ggplot(penguins, aes(x = flipper_length_mm,
                     y = body_mass_g))+
  geom_point(aes(colour = species, shape = species))+
  geom_smooth()+
  scale_colour_manual(values = c("black", "gold", "lightblue"))+
  labs(x = "Flipper length (mm)",
       y = "Body mass (g)",
       title = "Body mass and flipper length",
       subtitle = "Dimensions for Adelie, Chinstrap and Gentoo Penguins")
```

Lo logré!! Igual leeré el cap. Los colores evidentemente no son los mismos, pero detalles. Sí, me faltó algo que no supe resolver con el gráfico directamente (aunque podría renombrar la columna de penguins, pero no es la idea, es que en la leyenda sea "Species", en vez de "species").

Layers of ggplot.

Código final del libro:

```{r}
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g)
) +
  geom_point(aes(color = species, shape = species)) +
  geom_smooth(method = "lm") +  # importante! No me había fijado en eso
  labs(
    title = "Body mass and flipper length",
    subtitle = "Dimensions for Adelie, Chinstrap, and Gentoo Penguins",
    x = "Flipper length (mm)", y = "Body mass (g)",
    color = "Species", shape = "Species" # resuelta mi duda
  ) +
  scale_color_colorblind()
```

### Exercises

Otro ejemplo, sacarle el error estándar a geom_smooth():

```{r}
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g, color = island)
) +
  geom_point() +
  geom_smooth(se = FALSE)
```

Will these two graphs look different? Why/why not?
Yo creo que se verán iguales, porque es la misma base de datos y los mismos ejes.

```{r}
ggplot(
  data = penguins,
  mapping = aes(x = flipper_length_mm, y = body_mass_g)
) +
  geom_point() +
  geom_smooth()

ggplot() +
  geom_point(
    data = penguins,
    mapping = aes(x = flipper_length_mm, y = body_mass_g)
  ) +
  geom_smooth(
    data = penguins,
    mapping = aes(x = flipper_length_mm, y = body_mass_g)
  )
```

Como se escribe realmente o de manera actual:

```{r}
penguins %>%
  ggplot(aes(x = flipper_length_mm, y = body_mass_g)) + 
  geom_point()
```

### Variables categoricas

```{r}
ggplot(penguins, aes(x = species))+
  geom_bar() 

# si quiero ordenar barras por frecuencia:

ggplot(penguins, aes(x = fct_infreq(species)))+
  geom_bar() 
```

### Histograma de variables continuas

```{r}
ggplot(penguins, aes(x = body_mass_g))+
  geom_histogram(binwidth = 200) # ancho de barras

ggplot(penguins, aes(x = body_mass_g)) +
  geom_histogram(binwidth = 20)

ggplot(penguins, aes(x = body_mass_g)) +
  geom_histogram(binwidth = 2000)
```

### Density plot

Similar información a histograma.

```{r}
ggplot(penguins, aes(x = body_mass_g)) +
  geom_density()
```

### Exercises

Make a bar plot of species of penguins, where you assign species to the y aesthetic. How is this plot different?

```{r}
ggplot(penguins, aes(y = species))+
  geom_bar()
```

How are the following two plots different? Which aesthetic, color or fill, is more useful for changing the color of bars?

Entiendo que color rellenerá solo en contorno, y fill el relleno completo. Sirve mas fill.

```{r}
ggplot(penguins, aes(x = species)) +
  geom_bar(color = "red")

ggplot(penguins, aes(x = species)) +
  geom_bar(fill = "red")
```

Make a histogram of the carat variable in the diamonds dataset that is available when you load the tidyverse package. Experiment with different binwidths. What binwidth reveals the most interesting patterns?

```{r}
ggplot(diamonds, aes(x = carat))+
  geom_histogram()

ggplot(diamonds, aes(x = carat))+
  geom_histogram(binwidth = 10)

ggplot(diamonds, aes(x = carat))+
  geom_histogram(binwidth = 100)

ggplot(diamonds, aes(x = carat))+
  geom_histogram(binwidth = 1000)

ggplot(diamonds, aes(x = carat))+
  geom_histogram(binwidth = 1)

ggplot(diamonds, aes(x = carat))+
  geom_histogram(binwidth = 0.5)

ggplot(diamonds, aes(x = carat))+
  geom_histogram(binwidth = 0.01)

ggplot(diamonds, aes(x = carat))+
  geom_histogram(binwidth = 0.008)

# brigido!!
```

### Numerical and categorical variable

```{r}
# boxplots
ggplot(penguins, aes(x = species, y = body_mass_g))+
  geom_boxplot()

# también gráficos de densidad
ggplot(penguins, aes(x = body_mass_g, colour = species))+
  geom_density(linewidth = 0.75)

ggplot(penguins, aes(x = body_mass_g, colour = species, fill = species))+
  geom_density(alpha = 0.5) # por si se sobreponen
```

### Dos variables categoricas

```{r}
ggplot(penguins, aes(x = island, fill = species))+
  geom_bar()

# The second plot, a relative frequency plot created by setting position = "fill" in the geom, is more useful for comparing species distributions across islands since it’s not affected by the unequal numbers of penguins across the islands.

ggplot(penguins, aes(x = island, fill = species)) +
  geom_bar(position = "fill")
```

### Three or more variables

```{r}
ggplot(penguins, aes(x = flipper_length_mm, y = body_mass_g)) +
  geom_point(aes(color = species, shape = island))

# facetas
ggplot(penguins, aes(x = flipper_length_mm, y = body_mass_g)) +
  geom_point(aes(color = species, shape = species)) +
  facet_wrap(~island)
```

### Exercises

The mpg data frame that is bundled with the ggplot2 package contains 234 observations collected by the US Environmental Protection Agency on 38 car models. Which variables in mpg are categorical? Which variables are numerical? (Hint: Type ?mpg to read the documentation for the dataset.) How can you see this information when you run mpg?

```{r}
glimpse(mpg)
?mpg
# ahí pude ver todas las variables que son numéricas o categóricas.
```

Make a scatterplot of hwy vs. displ using the mpg data frame. Next, map a third, numerical variable to color, then size, then both color and size, then shape. How do these aesthetics behave differently for categorical vs. numerical variables?

```{r}
ggplot(mpg, aes(x = hwy, y = displ, colour = cty, size = cty, shape = class)) +
  geom_point()
```

In the scatterplot of hwy vs. displ, what happens if you map a third variable to linewidth?
Se ve extraño.

```{r}
ggplot(mpg, aes(x = hwy, y = displ))+
  geom_point() +
  geom_line(aes(x = hwy, y = cty))
```

What happens if you map the same variable to multiple aesthetics?

```{r}

```

Make a scatterplot of bill_depth_mm vs. bill_length_mm and color the points by species. What does adding coloring by species reveal about the relationship between these two variables? What about faceting by species?

```{r}

```

Why does the following yield two separate legends? How would you fix it to combine the two legends?

```{r}
ggplot(
  data = penguins,
  mapping = aes(
    x = bill_length_mm, y = bill_depth_mm, 
    color = species, shape = species
  )
) +
  geom_point() +
  labs(color = "Species")

# Respuesta:
ggplot(
  data = penguins,
  mapping = aes(
    x = bill_length_mm, y = bill_depth_mm, 
    color = species, shape = species
  )
) +
  geom_point() +
  labs(color = "Species", shape = "Species")
```

Create the two following stacked bar plots. Which question can you answer with the first one? Which question can you answer with the second one?

```{r}
ggplot(penguins, aes(x = island, fill = species)) +
  geom_bar(position = "fill") 
# Propoción de especies por isla

ggplot(penguins, aes(x = species, fill = island)) +
  geom_bar(position = "fill")
# Proporción de isla por cada especie, saber en qué islas vive cada especie.
```

### Saving plots

Con la función `ggsave()`. If you don’t specify the width and height they will be taken from the dimensions of the current plotting device.

```{r}
ggplot(penguins, aes(x = bill_depth_mm, y = bill_length_mm))+
  geom_point()
#ggsave(filename = "figuras/penguin-plot.png")
```

### Exercise

Run the following lines of code. Which of the two plots is saved as mpg-plot.png? Why?
El de puntos, porque es el último código que se corrió :).

```{r}
 ggplot(mpg, aes(x = class)) +
  geom_bar()
ggplot(mpg, aes(x = cty, y = hwy)) +
  geom_point()
#ggsave("mpg-plot.png")
```

What do you need to change in the code above to save the plot as a PDF instead of a PNG? How could you find out what types of image files would work in ggsave()? Cambiar el nombre terminando a .pdf.

```{r}
ggplot(mpg, aes(x = cty, y = hwy)) +
  geom_point()
#ggsave("figuras/mpg-plot.pdf") 
```

*Commons problems*: Check the left-hand of your console: if it’s a +, it means that R doesn’t think you’ve typed a complete expression and it’s waiting for you to finish it. In this case, it’s usually easy to start from scratch again by pressing ESCAPE to abort processing the current command.

## 2. Workflow: basics

Con command + (flechita hacia arriba) en la consola veo todo el codigo que corrí antes. 

Con tab me tira opciones cuando escribo una función.

```{r}
seq(from = 1, to=10)
```

Si es consola me queda un "+" significa que está esperando más código, si me quivoqué o no quiero nada más, apretar escape.

### 2.5 Exercises

Corregir:

```{r}
# libary(todyverse)
# 
# ggplot(dTA = mpg) + 
#   geom_point(maping = aes(x = displ y = hwy)) +
#   geom_smooth(method = "lm)

library(tidyverse)

ggplot(data = mpg, aes(x = displ, y = hwy)) + 
  geom_point() +
  geom_smooth(method = "lm")
```

Press Option + Shift + K / Alt + Shift + K. What happens? How can you get to the same place using the menus? 
Woow las opciones.

Let’s revisit an exercise from the Section 1.6. Run the following lines of code. Which of the two plots is saved as mpg-plot.png? Why?

```{r}
my_bar_plot <- ggplot(mpg, aes(x = class)) +
  geom_bar()
my_scatter_plot <- ggplot(mpg, aes(x = cty, y = hwy)) +
  geom_point()
#ggsave(filename = "figuras/mpg-plot.png", plot = my_bar_plot)
```

## 3. Data transformation

t’s rare that you get the data in exactly the right form you need to make the graph you want.

`dplyr package` to transformate.

```{r}
library(nycflights13) #data
library(tidyverse)
```

Take careful note of the conflicts message that’s printed when you load the tidyverse. It tells you that dplyr overwrites some functions in base R. If you want to use the base version of these functions after loading dplyr, you’ll need to use their full names: `stats::filter()` and `stats::lag()`.

```{r}
nycflights13::flights
?flights
flights
```

`flights` is a tibble, a special type of data frame used by the tidyverse to avoid some common gotchas. The most important difference between tibbles and data frames is the way tibbles print; they are designed for large datasets, so they only show the first few rows and only the columns that fit on one screen.

```{r}
glimpse(flights)
```

Funciones básicas y pipe:

```{r}
flights %>% 
  filter(dest == "IAH") %>%  
  group_by(year, month, day) %>% 
  summarize(
    arr_delay = mean(arr_delay, na.rm = TRUE)
  )
```

### 3.2 Rows

#### filter()

```{r}
flights |> 
  filter(month %in% c(1, 2))
```

#### arrange() / desc()

```{r}
flights |> 
  arrange(year, month, day, dep_time)

flights |> 
  arrange(desc(dep_delay))
```

#### distinct()

Finds all the unique rows in a dataset, so technically, it primarily operates on the rows.

```{r}
flights |> 
  distinct()

flights |> 
  distinct(origin, dest)

# If you want to keep the other columns when filtering for unique rows
flights |> 
  distinct(origin, dest, .keep_all = TRUE) 
```

#### count()

If you want to find the number of occurrences instead, you’re better off swapping distinct() for count(). With the sort = TRUE argument, you can arrange them in descending order of the number of occurrences.

```{r}
flights |>
  count(origin, dest, sort = TRUE)

flights |>
  count(origin)

flights |>
  count(dest)
```

#### 3.2.5 Exercise

In a single pipeline for each condition, find all flights that meet the condition:

Had an arrival delay of two or more hours
Flew to Houston (IAH or HOU)
*Were operated by United, American, or Delta*
Departed in summer (July, August, and September)
Arrived more than two hours late but didn’t leave late
Were delayed by at least an hour, but made up over 30 minutes in flight

```{r}
# flights1 <- flights %>% 
#   filter(arr_delay >= 120,
#          dest == "IAH" | dest == "HOU",
#          month %in% c(7, 8, 9)
#          )
```

Ordena flights para encontrar los vuelos con mayor retraso. Encuentra los vuelos que salieron más temprano por la mañana.

```{r}
flights %>% arrange(-arr_delay)
```



pendiente terminar ejercicios!